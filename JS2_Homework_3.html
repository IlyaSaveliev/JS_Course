<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="normalize.css">
    <link rel="stylesheet" href="style.css">
    <title>Internet magazin</title>
</head>

<body>

    <header>
        <div class="logo">Интернет-магазин</div>
        <button class="btn-cart" type="button">Корзина</button>
    </header>
    <main>
        <div class="products"></div>
        <hr>
        <div>
            <h2 class="logo">Корзина</h2>
        </div>
        <div class="basket"></div>
        <div class="basket-btn">
            <button class="clr-basket" type="button">Очистить корзину</button>
        </div>
    </main>

    <script>

        const API = 'https://raw.githubusercontent.com/GeekBrainsTutorial/online-store-api/master/responses';
        // Перевести на Promise НЕ ИСПОЛЬЗОВАТЬ fetch
        let getRequest = (url, callBack) => {
            let xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    if (xhr.status !== 200) {
                        console.log('Error');
                    } else {
                        callBack(xhr.responseText);
                    }
                }
            }
            xhr.send();
        };

        class ProductList {
            #goods;
            #allProducts;

            constructor(container = '.products') {
                console.log('constructor');
                this.container = container;
                this.#goods = [];
                this.#allProducts = [];

                this.#getProducts()
                    .then((data) => {
                        this.#goods = [...data];
                        this.#render();
                    });

            }

            goodsTotalPrice() {
                return this.#goods.reduce((sum, { price }) => sum + price, 0);
            }

            #getProducts() {
                return fetch(`${API}/catalogData.json`)
                    .then((response) => response.json())
                    .catch((error) => {
                        console.log(error);
                    });
            }

            #render() {
                const block = document.querySelector(this.container);

                this.#goods.forEach((product) => {
                    const productObject = new ProductItem(product);
                    console.log(productObject);
                    this.#allProducts.push(productObject);
                    block.insertAdjacentHTML('beforeend', productObject.render());
                });
            }
        }

        class ProductItem {
            constructor(product, img = 'https://placehold.it/200x150') {
                this.product_name = product.product_name;
                this.price = product.price;
                this.id_product = product.id_product;
                this.img = img;
            }

            render() {
                return `<div class="product-item" data-id="${this.id_product}" >
                <img src="${this.img}" alt="Some img">
                <div class="desc">
                    <h3>${this.product_name}</h3>
                    <p>${this.price} \u20bd</p>
                    <button class="buy-btn">Купить</button>
                </div>
          </div>`;
            }
        }

        class BasketList {
            #goods;
            #allBasketProducts;

            constructor(container = '.basket') {
                console.log('constructor');
                this.container = container;
                this.#goods = [];
                this.#allBasketProducts = [];

                this.#getProducts()
                    .then((data) => {
                        this.#goods = [...data];
                        this.#render();
                    });

            }

            #getProducts() {
                return fetch(`${API}/catalogData.json`)
                    .then((response) => response.json())
                    .catch((error) => {
                        console.log(error);
                    });
            }

            #clearBasket() {
            }

            getAddToBasket() {
            }

            getBasketPrice() {
                return this.#allBasketProducts.reduce((sum, { price }) => sum + price, 0);
            }

            getBasketLength() {
                return this.#allBasketProducts.length;
            }

            renderEmptyCart() {
                const block = document.querySelector(this.container);
                block.insertAdjacentHTML('beforeend', 'Корзина пуста.');
            }

            #render() {
                if (this.getBasketLength() > 0) {

                    const block = document.querySelector(this.container);

                    // this.#allBasketProducts.forEach((product) => {
                    this.#goods.forEach((product) => {
                        const basketObject = new BasketItem(product);
                        console.log(basketObject);
                        this.#allBasketProducts.push(basketObject);
                        block.insertAdjacentHTML('beforeend', basketObject.render());
                    });
                    block.insertAdjacentHTML('beforebegin', `В корзине товаров на сумму ${this.getBasketPrice()} руб.`);
                }
                else {
                    this.renderEmptyCart();
                }
            }

        }

        class BasketItem {
            constructor(product, img = 'https://placehold.it/200x150') {
                this.product_name = product.product_name;
                this.price = product.price;
                this.id_product = product.id_product;
                this.img = img;
            }

            render() {
                return `<div class="basket-item" data-id="${this.id_product}" >
                <img src="${this.img}" alt="Some img">
                <div class="desc">
                    <h3>${this.product_name}</h3>
                    <p>${this.price} \u20bd</p>
                </div>
                </div>`;
            }
        }


        const productList = new ProductList();
        const basketList = new BasketList();

    </script>

</body>

</html>